name: Build Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build EXE
      run: |
        if (Test-Path "app.ico") {
          pyinstaller --onefile --windowed --icon=app.ico --add-data "app.ico;." --name CloudflareSpeedTest-GUI CloudflareSpeedTest-GUI.py
        } else {
          pyinstaller --onefile --windowed --name CloudflareSpeedTest-GUI CloudflareSpeedTest-GUI.py
        }
      shell: pwsh
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: CloudflareSpeedTest-GUI-Windows
        path: dist/CloudflareSpeedTest-GUI.exe
        retention-days: 30

  build-openwrt:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build OpenWrt LuCI package
      run: |
        # åˆ›å»º ipk åŒ…ç»“æž„
        mkdir -p openwrt-package/luci-app-cfspeedtest/root/usr/lib/lua/luci/controller
        mkdir -p openwrt-package/luci-app-cfspeedtest/root/usr/lib/lua/luci/model/cbi
        mkdir -p openwrt-package/luci-app-cfspeedtest/root/usr/lib/lua/luci/view/cfspeedtest
        mkdir -p openwrt-package/luci-app-cfspeedtest/root/etc/config
        mkdir -p openwrt-package/luci-app-cfspeedtest/root/etc/init.d
        mkdir -p openwrt-package/luci-app-cfspeedtest/root/usr/bin
        
        # å¤åˆ¶ LuCI æ–‡ä»¶
        cp -r openwrt/luci/* openwrt-package/luci-app-cfspeedtest/root/usr/lib/lua/luci/
        cp openwrt/cfspeedtest.config openwrt-package/luci-app-cfspeedtest/root/etc/config/cfspeedtest
        cp openwrt/cfspeedtest.init openwrt-package/luci-app-cfspeedtest/root/etc/init.d/cfspeedtest
        cp openwrt/cfspeedtest.sh openwrt-package/luci-app-cfspeedtest/root/usr/bin/cfspeedtest
        chmod +x openwrt-package/luci-app-cfspeedtest/root/etc/init.d/cfspeedtest
        chmod +x openwrt-package/luci-app-cfspeedtest/root/usr/bin/cfspeedtest
        
        # åˆ›å»ºæŽ§åˆ¶æ–‡ä»¶
        mkdir -p openwrt-package/luci-app-cfspeedtest/CONTROL
        cat > openwrt-package/luci-app-cfspeedtest/CONTROL/control << 'EOF'
        Package: luci-app-cfspeedtest
        Version: 1.0.0
        Depends: libc, luci-base
        Section: luci
        Architecture: all
        Maintainer: CloudflareSpeedTest-GUI
        Description: LuCI support for CloudflareSpeedTest
        EOF
        
        # æ‰“åŒ… ipk
        cd openwrt-package
        tar -czvf data.tar.gz -C luci-app-cfspeedtest/root .
        tar -czvf control.tar.gz -C luci-app-cfspeedtest/CONTROL .
        echo "2.0" > debian-binary
        tar -czvf ../luci-app-cfspeedtest_1.0.0_all.ipk debian-binary data.tar.gz control.tar.gz
        cd ..
      continue-on-error: true
    
    - name: Upload OpenWrt artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-cfspeedtest-OpenWrt
        path: luci-app-cfspeedtest_1.0.0_all.ipk
        retention-days: 30
      continue-on-error: true

  release:
    needs: [build-windows, build-openwrt]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: CloudflareSpeedTest-GUI-Windows
        path: ./release
    
    - name: Download OpenWrt artifact
      uses: actions/download-artifact@v4
      with:
        name: luci-app-cfspeedtest-OpenWrt
        path: ./release
      continue-on-error: true
    
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT
    
    - name: Generate changelog
      id: changelog
      run: |
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "## æ›´æ–°æ—¥å¿—" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ðŸ†• æœ¬æ¬¡æ›´æ–°" >> $GITHUB_OUTPUT
        git log --pretty=format:"- %s" -10 >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž" >> $GITHUB_OUTPUT
        echo "- **Windows**: ä¸‹è½½ \`CloudflareSpeedTest-GUI.exe\`" >> $GITHUB_OUTPUT
        echo "- **OpenWrt**: ä¸‹è½½ \`luci-app-cfspeedtest_1.0.0_all.ipk\` å¹¶é€šè¿‡ LuCI ä¸Šä¼ å®‰è£…" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### âœ¨ ä¸»è¦åŠŸèƒ½" >> $GITHUB_OUTPUT
        echo "- ðŸ–¥ï¸ æµ‹é€Ÿç»“æžœå®žæ—¶æ˜¾ç¤º" >> $GITHUB_OUTPUT
        echo "- ðŸ“Š è¿›åº¦æ¡æ˜¾ç¤ºæµ‹é€Ÿè¿›åº¦" >> $GITHUB_OUTPUT
        echo "- ðŸ“‹ ç»“æžœæŸ¥çœ‹å™¨ (è¡¨æ ¼å±•ç¤º)" >> $GITHUB_OUTPUT
        echo "- ðŸ“‹ ä¸€é”®å¤åˆ¶æœ€ä¼˜ IP" >> $GITHUB_OUTPUT
        echo "- ðŸŒ™ æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢" >> $GITHUB_OUTPUT
        echo "- ðŸ“Œ ç³»ç»Ÿæ‰˜ç›˜æ”¯æŒ" >> $GITHUB_OUTPUT
        echo "- ðŸ”„ è‡ªåŠ¨æ›´æ–° IP åº“" >> $GITHUB_OUTPUT
        echo "- ðŸ“œ æµ‹é€ŸåŽ†å²è®°å½•" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "---" >> $GITHUB_OUTPUT
        echo "æž„å»ºæ—¶é—´: ${{ steps.date.outputs.date }}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.date.outputs.date }}
        name: Release ${{ steps.date.outputs.date }}
        files: |
          ./release/*
        body: ${{ steps.changelog.outputs.changelog }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
