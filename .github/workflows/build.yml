name: Build Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build EXE
      run: |
        if (Test-Path "app.ico") {
          pyinstaller --onefile --windowed --icon=app.ico --add-data "app.ico;." --name CloudflareSpeedTest-GUI CloudflareSpeedTest-GUI.py
        } else {
          pyinstaller --onefile --windowed --name CloudflareSpeedTest-GUI CloudflareSpeedTest-GUI.py
        }
      shell: pwsh
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: CloudflareSpeedTest-GUI-Windows
        path: dist/CloudflareSpeedTest-GUI.exe
        retention-days: 30

  build-openwrt:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build OpenWrt LuCI package
      run: |
        # åˆ›å»º ipk åŒ…ç»“æž„
        PKG_DIR="openwrt-package/luci-app-cfspeedtest"
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/controller
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/model/cbi/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/view/cfspeedtest
        mkdir -p $PKG_DIR/root/etc/config
        mkdir -p $PKG_DIR/root/etc/init.d
        mkdir -p $PKG_DIR/root/etc/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/bin
        
        # å¤åˆ¶ LuCI æŽ§åˆ¶å™¨
        cp openwrt/luci/controller/cfspeedtest.lua $PKG_DIR/root/usr/lib/lua/luci/controller/
        
        # å¤åˆ¶ CBI æ¨¡åž‹
        cp openwrt/luci/model/cbi/cfspeedtest/*.lua $PKG_DIR/root/usr/lib/lua/luci/model/cbi/cfspeedtest/
        
        # å¤åˆ¶è§†å›¾æ¨¡æ¿
        cp openwrt/luci/view/cfspeedtest/*.htm $PKG_DIR/root/usr/lib/lua/luci/view/cfspeedtest/
        
        # å¤åˆ¶é…ç½®å’Œè„šæœ¬
        cp openwrt/cfspeedtest.config $PKG_DIR/root/etc/config/cfspeedtest
        cp openwrt/cfspeedtest.init $PKG_DIR/root/etc/init.d/cfspeedtest
        cp openwrt/cfspeedtest.sh $PKG_DIR/root/usr/bin/cfspeedtest
        cp openwrt/cfspeedtest_update_ip.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_ip
        cp openwrt/cfspeedtest_update_cfst.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_cfst
        
        # è®¾ç½®æƒé™
        chmod +x $PKG_DIR/root/etc/init.d/cfspeedtest
        chmod +x $PKG_DIR/root/usr/bin/cfspeedtest
        chmod +x $PKG_DIR/root/usr/bin/cfspeedtest_update_ip
        chmod +x $PKG_DIR/root/usr/bin/cfspeedtest_update_cfst
        
        # åˆ›å»ºæŽ§åˆ¶æ–‡ä»¶
        mkdir -p $PKG_DIR/CONTROL
        cat > $PKG_DIR/CONTROL/control << 'EOF'
        Package: luci-app-cfspeedtest
        Version: 2.0.0
        Depends: libc, luci-base, wget
        Section: luci
        Architecture: all
        Maintainer: CloudflareSpeedTest-GUI
        Description: LuCI support for CloudflareSpeedTest
         Cloudflare ä¼˜é€‰ IP æµ‹é€Ÿå·¥å…· LuCI ç•Œé¢
         åŠŸèƒ½åŒ…æ‹¬ï¼š
         - å¯è§†åŒ–å‚æ•°é…ç½®
         - å®žæ—¶æ—¥å¿—æ˜¾ç¤º
         - ç»“æžœå¯è§†åŒ–å›¾è¡¨
         - åŽ†å²è®°å½•
         - å®šæ—¶æµ‹é€Ÿ
         - è‡ªåŠ¨åº”ç”¨æœ€ä¼˜IP
         - Passwall/SSR Plus è”åŠ¨
         - è‡ªå®šä¹‰IPæ®µ
         - CloudflareST ç‰ˆæœ¬ç®¡ç†
        EOF
        
        # åˆ›å»º postinst è„šæœ¬
        cat > $PKG_DIR/CONTROL/postinst << 'EOF'
        #!/bin/sh
        [ -z "$IPKG_INSTROOT" ] && {
            /etc/init.d/cfspeedtest enable
            rm -rf /tmp/luci-*
        }
        exit 0
        EOF
        chmod +x $PKG_DIR/CONTROL/postinst
        
        # åˆ›å»º prerm è„šæœ¬
        cat > $PKG_DIR/CONTROL/prerm << 'EOF'
        #!/bin/sh
        [ -z "$IPKG_INSTROOT" ] && {
            /etc/init.d/cfspeedtest stop
            /etc/init.d/cfspeedtest disable
        }
        exit 0
        EOF
        chmod +x $PKG_DIR/CONTROL/prerm
        
        # æ‰“åŒ… ipk
        cd openwrt-package
        tar -czvf data.tar.gz -C luci-app-cfspeedtest/root .
        tar -czvf control.tar.gz -C luci-app-cfspeedtest/CONTROL .
        echo "2.0" > debian-binary
        tar -czvf ../luci-app-cfspeedtest_2.0.0_all.ipk debian-binary data.tar.gz control.tar.gz
        cd ..
        
        echo "IPK åŒ…æž„å»ºå®Œæˆ"
        ls -la *.ipk
    
    - name: Upload OpenWrt artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-cfspeedtest-OpenWrt
        path: luci-app-cfspeedtest_2.0.0_all.ipk
        retention-days: 30

  release:
    needs: [build-windows, build-openwrt]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: CloudflareSpeedTest-GUI-Windows
        path: ./release
    
    - name: Download OpenWrt artifact
      uses: actions/download-artifact@v4
      with:
        name: luci-app-cfspeedtest-OpenWrt
        path: ./release
    
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT
    
    - name: Generate changelog
      id: changelog
      run: |
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "## ðŸŽ‰ CloudflareSpeedTest-GUI Release" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ðŸ“ æ›´æ–°æ—¥å¿—" >> $GITHUB_OUTPUT
        git log --pretty=format:"- %s" -10 >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "---" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "| å¹³å° | æ–‡ä»¶ | è¯´æ˜Ž |" >> $GITHUB_OUTPUT
        echo "|------|------|------|" >> $GITHUB_OUTPUT
        echo "| Windows | \`CloudflareSpeedTest-GUI.exe\` | åŒå‡»è¿è¡Œï¼Œéœ€è¦ cfst.exe å’Œ ip.txt |" >> $GITHUB_OUTPUT
        echo "| OpenWrt | \`luci-app-cfspeedtest_2.0.0_all.ipk\` | é€šè¿‡ LuCI ä¸Šä¼ å®‰è£… |" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "---" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### âœ¨ Windows åŠŸèƒ½" >> $GITHUB_OUTPUT
        echo "- ðŸ–¥ï¸ æµ‹é€Ÿç»“æžœå®žæ—¶æ˜¾ç¤º" >> $GITHUB_OUTPUT
        echo "- ðŸ“Š è¿›åº¦æ¡æ˜¾ç¤ºæµ‹é€Ÿè¿›åº¦" >> $GITHUB_OUTPUT
        echo "- ðŸ“‹ ç»“æžœæŸ¥çœ‹å™¨ (è¡¨æ ¼å±•ç¤º)" >> $GITHUB_OUTPUT
        echo "- ðŸ“‹ ä¸€é”®å¤åˆ¶æœ€ä¼˜ IP" >> $GITHUB_OUTPUT
        echo "- ðŸŒ™ æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢" >> $GITHUB_OUTPUT
        echo "- ðŸ“Œ ç³»ç»Ÿæ‰˜ç›˜æ”¯æŒ" >> $GITHUB_OUTPUT
        echo "- ðŸ”„ è‡ªåŠ¨æ›´æ–° IP åº“ (å›½å†…ä»£ç†)" >> $GITHUB_OUTPUT
        echo "- ðŸ“œ æµ‹é€ŸåŽ†å²è®°å½•" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### âœ¨ OpenWrt LuCI åŠŸèƒ½" >> $GITHUB_OUTPUT
        echo "- âš™ï¸ å¯è§†åŒ–å‚æ•°é…ç½®" >> $GITHUB_OUTPUT
        echo "- ðŸ“º å®žæ—¶æ—¥å¿—æ˜¾ç¤º" >> $GITHUB_OUTPUT
        echo "- ðŸ“Š ç»“æžœå¯è§†åŒ–å›¾è¡¨" >> $GITHUB_OUTPUT
        echo "- ðŸ“œ åŽ†å²è®°å½•ä¿å­˜" >> $GITHUB_OUTPUT
        echo "- â° å®šæ—¶æµ‹é€Ÿä»»åŠ¡" >> $GITHUB_OUTPUT
        echo "- ðŸš€ è‡ªåŠ¨åº”ç”¨æœ€ä¼˜ IP" >> $GITHUB_OUTPUT
        echo "- ðŸ”— Passwall/SSR Plus/OpenClash è”åŠ¨" >> $GITHUB_OUTPUT
        echo "- ðŸ“ è‡ªå®šä¹‰ IP æ®µ" >> $GITHUB_OUTPUT
        echo "- ðŸ“¤ ç»“æžœå¯¼å‡º (CSV/JSON)" >> $GITHUB_OUTPUT
        echo "- ðŸ”§ CloudflareST ç‰ˆæœ¬ç®¡ç†" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "---" >> $GITHUB_OUTPUT
        echo "æž„å»ºæ—¶é—´: ${{ steps.date.outputs.date }}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.date.outputs.date }}
        name: Release ${{ steps.date.outputs.date }}
        files: |
          ./release/*
        body: ${{ steps.changelog.outputs.changelog }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
