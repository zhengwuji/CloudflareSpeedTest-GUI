name: Build Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build EXE
      run: |
        if (Test-Path "app.ico") {
          pyinstaller --onefile --windowed --icon=app.ico --add-data "app.ico;." --name CloudflareSpeedTest-GUI CloudflareSpeedTest-GUI.py
        } else {
          pyinstaller --onefile --windowed --name CloudflareSpeedTest-GUI CloudflareSpeedTest-GUI.py
        }
      shell: pwsh
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: CloudflareSpeedTest-GUI-Windows
        path: dist/CloudflareSpeedTest-GUI.exe
        retention-days: 30

  build-openwrt:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get and increment version
      id: version
      run: |
        # è¯»å–å½“å‰ç‰ˆæœ¬
        if [ -f VERSION ]; then
          CURRENT_VERSION=$(cat VERSION | tr -d '\r\n')
        else
          CURRENT_VERSION="1.0.0"
        fi
        
        # è§£æç‰ˆæœ¬å·
        MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
        MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
        PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
        
        # é€’å¢ patch ç‰ˆæœ¬
        PATCH=$((PATCH + 1))
        NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
        
        echo "Current version: $CURRENT_VERSION"
        echo "New version: $NEW_VERSION"
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        echo "$NEW_VERSION" > VERSION
    
    - name: Build OpenWrt Legacy LuCI package
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        PKG_DIR="pkg-legacy/luci-app-cfspeedtest"
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/controller
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/model/cbi/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/view/cfspeedtest
        mkdir -p $PKG_DIR/root/etc/config
        mkdir -p $PKG_DIR/root/etc/init.d
        mkdir -p $PKG_DIR/root/etc/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/bin
        mkdir -p $PKG_DIR/CONTROL
        
        cp openwrt/luci/controller/cfspeedtest.lua $PKG_DIR/root/usr/lib/lua/luci/controller/
        cp openwrt/luci/model/cbi/cfspeedtest/*.lua $PKG_DIR/root/usr/lib/lua/luci/model/cbi/cfspeedtest/
        cp openwrt/luci/view/cfspeedtest/*.htm $PKG_DIR/root/usr/lib/lua/luci/view/cfspeedtest/
        cp openwrt/cfspeedtest.config $PKG_DIR/root/etc/config/cfspeedtest
        cp openwrt/cfspeedtest.init $PKG_DIR/root/etc/init.d/cfspeedtest
        cp openwrt/cfspeedtest.sh $PKG_DIR/root/usr/bin/cfspeedtest
        cp openwrt/cfspeedtest_update_ip.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_ip
        cp openwrt/cfspeedtest_update_cfst.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_cfst
        cp openwrt/cfspeedtest_apply.sh $PKG_DIR/root/usr/bin/cfspeedtest_apply
        
        chmod +x $PKG_DIR/root/etc/init.d/cfspeedtest
        chmod +x $PKG_DIR/root/usr/bin/*
        
        echo "Package: luci-app-cfspeedtest" > $PKG_DIR/CONTROL/control
        echo "Version: $VERSION" >> $PKG_DIR/CONTROL/control
        echo "Depends: libc, luci-base, wget" >> $PKG_DIR/CONTROL/control
        echo "Section: luci" >> $PKG_DIR/CONTROL/control
        echo "Architecture: all" >> $PKG_DIR/CONTROL/control
        echo "Maintainer: CloudflareSpeedTest-GUI" >> $PKG_DIR/CONTROL/control
        echo "Description: LuCI support for CloudflareSpeedTest (Legacy)" >> $PKG_DIR/CONTROL/control
        
        cd pkg-legacy
        tar -czvf data.tar.gz -C luci-app-cfspeedtest/root .
        tar -czvf control.tar.gz -C luci-app-cfspeedtest/CONTROL .
        echo "2.0" > debian-binary
        tar -czvf ../luci-app-cfspeedtest_${VERSION}_legacy.ipk debian-binary data.tar.gz control.tar.gz
    
    - name: Build OpenWrt JS LuCI package
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        PKG_DIR="pkg-js/luci-app-cfspeedtest"
        mkdir -p $PKG_DIR/root/www/luci-static/resources/view/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/share/luci/menu.d
        mkdir -p $PKG_DIR/root/usr/share/rpcd/acl.d
        mkdir -p $PKG_DIR/root/etc/config
        mkdir -p $PKG_DIR/root/etc/init.d
        mkdir -p $PKG_DIR/root/etc/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/bin
        mkdir -p $PKG_DIR/CONTROL
        
        cp openwrt/luci-js/htdocs/luci-static/resources/view/cfspeedtest/*.js $PKG_DIR/root/www/luci-static/resources/view/cfspeedtest/
        cp openwrt/luci-js/htdocs/luci-static/resources/view/cfspeedtest.js $PKG_DIR/root/www/luci-static/resources/view/
        cp openwrt/luci-js/root/usr/share/luci/menu.d/*.json $PKG_DIR/root/usr/share/luci/menu.d/
        cp openwrt/luci-js/root/usr/share/rpcd/acl.d/*.json $PKG_DIR/root/usr/share/rpcd/acl.d/
        cp openwrt/cfspeedtest.config $PKG_DIR/root/etc/config/cfspeedtest
        cp openwrt/cfspeedtest.init $PKG_DIR/root/etc/init.d/cfspeedtest
        cp openwrt/cfspeedtest.sh $PKG_DIR/root/usr/bin/cfspeedtest
        cp openwrt/cfspeedtest_update_ip.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_ip
        cp openwrt/cfspeedtest_update_cfst.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_cfst
        cp openwrt/cfspeedtest_apply.sh $PKG_DIR/root/usr/bin/cfspeedtest_apply
        
        chmod +x $PKG_DIR/root/etc/init.d/cfspeedtest
        chmod +x $PKG_DIR/root/usr/bin/*
        
        echo "Package: luci-app-cfspeedtest" > $PKG_DIR/CONTROL/control
        echo "Version: $VERSION" >> $PKG_DIR/CONTROL/control
        echo "Depends: libc, luci-base, wget" >> $PKG_DIR/CONTROL/control
        echo "Section: luci" >> $PKG_DIR/CONTROL/control
        echo "Architecture: all" >> $PKG_DIR/CONTROL/control
        echo "Maintainer: CloudflareSpeedTest-GUI" >> $PKG_DIR/CONTROL/control
        echo "Description: LuCI support for CloudflareSpeedTest (JS for OpenWrt 21.02+)" >> $PKG_DIR/CONTROL/control
        
        echo '#!/bin/sh' > $PKG_DIR/CONTROL/postinst
        echo '[ -z "$IPKG_INSTROOT" ] && {' >> $PKG_DIR/CONTROL/postinst
        echo '    /etc/init.d/cfspeedtest enable 2>/dev/null' >> $PKG_DIR/CONTROL/postinst
        echo '    /etc/init.d/rpcd restart 2>/dev/null' >> $PKG_DIR/CONTROL/postinst
        echo '    rm -rf /tmp/luci-*' >> $PKG_DIR/CONTROL/postinst
        echo '    echo "LuCI cache cleared"' >> $PKG_DIR/CONTROL/postinst
        echo '}' >> $PKG_DIR/CONTROL/postinst
        echo 'exit 0' >> $PKG_DIR/CONTROL/postinst
        chmod +x $PKG_DIR/CONTROL/postinst
        
        # å¸è½½å‰è„šæœ¬
        echo '#!/bin/sh' > $PKG_DIR/CONTROL/prerm
        echo '[ -z "$IPKG_INSTROOT" ] && {' >> $PKG_DIR/CONTROL/prerm
        echo '    /etc/init.d/cfspeedtest stop 2>/dev/null' >> $PKG_DIR/CONTROL/prerm
        echo '    /etc/init.d/cfspeedtest disable 2>/dev/null' >> $PKG_DIR/CONTROL/prerm
        echo '}' >> $PKG_DIR/CONTROL/prerm
        echo 'exit 0' >> $PKG_DIR/CONTROL/prerm
        chmod +x $PKG_DIR/CONTROL/prerm
        
        # å¸è½½åè„šæœ¬
        echo '#!/bin/sh' > $PKG_DIR/CONTROL/postrm
        echo '[ -z "$IPKG_INSTROOT" ] && {' >> $PKG_DIR/CONTROL/postrm
        echo '    rm -rf /tmp/luci-*' >> $PKG_DIR/CONTROL/postrm
        echo '    /etc/init.d/rpcd restart 2>/dev/null' >> $PKG_DIR/CONTROL/postrm
        echo '    echo "LuCI cache cleared after uninstall"' >> $PKG_DIR/CONTROL/postrm
        echo '}' >> $PKG_DIR/CONTROL/postrm
        echo 'exit 0' >> $PKG_DIR/CONTROL/postrm
        chmod +x $PKG_DIR/CONTROL/postrm
        
        cd pkg-js
        tar -czvf data.tar.gz -C luci-app-cfspeedtest/root .
        tar -czvf control.tar.gz -C luci-app-cfspeedtest/CONTROL .
        echo "2.0" > debian-binary
        tar -czvf ../luci-app-cfspeedtest_${VERSION}_all.ipk debian-binary data.tar.gz control.tar.gz
    
    - name: Build LuCI Clear Cache package
      run: |
        PKG_DIR="pkg-cache/luci-clear-cache"
        mkdir -p $PKG_DIR/root/usr/bin
        mkdir -p $PKG_DIR/CONTROL
        
        cp openwrt/luci-clear-cache/clear_luci_cache.sh $PKG_DIR/root/usr/bin/clear_luci_cache
        chmod +x $PKG_DIR/root/usr/bin/clear_luci_cache
        
        echo "Package: luci-clear-cache" > $PKG_DIR/CONTROL/control
        echo "Version: 1.0.0" >> $PKG_DIR/CONTROL/control
        echo "Depends: libc" >> $PKG_DIR/CONTROL/control
        echo "Section: luci" >> $PKG_DIR/CONTROL/control
        echo "Architecture: all" >> $PKG_DIR/CONTROL/control
        echo "Maintainer: CloudflareSpeedTest-GUI" >> $PKG_DIR/CONTROL/control
        echo "Description: Auto clear LuCI cache on install/uninstall" >> $PKG_DIR/CONTROL/control
        
        # å®‰è£…åè‡ªåŠ¨æ¸…é™¤ç¼“å­˜
        echo '#!/bin/sh' > $PKG_DIR/CONTROL/postinst
        echo '[ -z "$IPKG_INSTROOT" ] && {' >> $PKG_DIR/CONTROL/postinst
        echo '    echo "Clearing LuCI cache..."' >> $PKG_DIR/CONTROL/postinst
        echo '    rm -rf /tmp/luci-*' >> $PKG_DIR/CONTROL/postinst
        echo '    /etc/init.d/rpcd restart 2>/dev/null' >> $PKG_DIR/CONTROL/postinst
        echo '    echo "LuCI cache cleared!"' >> $PKG_DIR/CONTROL/postinst
        echo '}' >> $PKG_DIR/CONTROL/postinst
        echo 'exit 0' >> $PKG_DIR/CONTROL/postinst
        chmod +x $PKG_DIR/CONTROL/postinst
        
        # å¸è½½åä¹Ÿæ¸…é™¤ç¼“å­˜
        echo '#!/bin/sh' > $PKG_DIR/CONTROL/postrm
        echo '[ -z "$IPKG_INSTROOT" ] && {' >> $PKG_DIR/CONTROL/postrm
        echo '    rm -rf /tmp/luci-*' >> $PKG_DIR/CONTROL/postrm
        echo '    /etc/init.d/rpcd restart 2>/dev/null' >> $PKG_DIR/CONTROL/postrm
        echo '}' >> $PKG_DIR/CONTROL/postrm
        echo 'exit 0' >> $PKG_DIR/CONTROL/postrm
        chmod +x $PKG_DIR/CONTROL/postrm
        
        cd pkg-cache
        tar -czvf data.tar.gz -C luci-clear-cache/root .
        tar -czvf control.tar.gz -C luci-clear-cache/CONTROL .
        echo "2.0" > debian-binary
        tar -czvf ../luci-clear-cache_1.0.0_all.ipk debian-binary data.tar.gz control.tar.gz
    
    - name: Upload OpenWrt artifacts
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-cfspeedtest-OpenWrt
        path: |
          luci-app-cfspeedtest_*_all.ipk
          luci-app-cfspeedtest_*_legacy.ipk
          luci-clear-cache_*_all.ipk
        retention-days: 30
    
    - name: Commit version update
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add VERSION
        git diff --staged --quiet || git commit -m "Bump version to ${{ steps.version.outputs.version }}"
        git push || true

  release:
    needs: [build-windows, build-openwrt]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./release
        merge-multiple: true
    
    - name: List release files
      run: ls -la ./release/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.build-openwrt.outputs.version }}
        name: Release v${{ needs.build-openwrt.outputs.version }}
        files: |
          ./release/*
        body: |
          ## CloudflareSpeedTest-GUI v${{ needs.build-openwrt.outputs.version }}
          
          ### ğŸ“¦ ä¸‹è½½
          | å¹³å° | æ–‡ä»¶ | é€‚ç”¨ç‰ˆæœ¬ |
          |------|------|----------|
          | Windows | `CloudflareSpeedTest-GUI.exe` | Windows 7+ |
          | OpenWrt | `luci-app-cfspeedtest_${{ needs.build-openwrt.outputs.version }}_all.ipk` | **OpenWrt 21.02+** (æ¨è) |
          | OpenWrt | `luci-app-cfspeedtest_${{ needs.build-openwrt.outputs.version }}_legacy.ipk` | OpenWrt 18.x - 22.x |
          | OpenWrt | `luci-clear-cache_1.0.0_all.ipk` | ğŸ§¹ LuCIç¼“å­˜æ¸…é™¤å·¥å…· (ç‹¬ç«‹) |
          
          ### âœ¨ åŠŸèƒ½
          - Windows GUI æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢
          - OpenWrt LuCI å¯è§†åŒ–é…ç½®ç•Œé¢
          - å®æ—¶æ—¥å¿— / ç»“æœå¯è§†åŒ– / å†å²è®°å½•
          - å®šæ—¶æµ‹é€Ÿ / è‡ªåŠ¨åº”ç”¨æœ€ä¼˜IP
          - Passwall / SSR Plus / OpenClash / MosDNS è”åŠ¨
          
          ### ğŸ§¹ LuCIç¼“å­˜æ¸…é™¤å·¥å…·
          ç‹¬ç«‹IPKï¼Œå®‰è£…æ—¶è‡ªåŠ¨æ¸…é™¤LuCIç¼“å­˜ã€‚å®‰è£…ä»»ä½•LuCIåº”ç”¨é‡åˆ°é—®é¢˜æ—¶å¯å…ˆå®‰è£…æ­¤å·¥å…·æ¸…é™¤ç¼“å­˜ã€‚
          ```bash
          opkg install luci-clear-cache_1.0.0_all.ipk
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
