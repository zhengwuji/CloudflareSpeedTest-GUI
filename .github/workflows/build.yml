name: Build Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build EXE
      run: |
        if (Test-Path "app.ico") {
          pyinstaller --onefile --windowed --icon=app.ico --add-data "app.ico;." --name CloudflareSpeedTest-GUI CloudflareSpeedTest-GUI.py
        } else {
          pyinstaller --onefile --windowed --name CloudflareSpeedTest-GUI CloudflareSpeedTest-GUI.py
        }
      shell: pwsh
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: CloudflareSpeedTest-GUI-Windows
        path: dist/CloudflareSpeedTest-GUI.exe
        retention-days: 30

  build-openwrt-legacy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build OpenWrt Legacy LuCI package
      run: |
        # åˆ›å»ºä¼ ç»Ÿ Lua ç‰ˆæœ¬ ipk
        PKG_DIR="pkg-legacy/luci-app-cfspeedtest"
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/controller
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/model/cbi/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/view/cfspeedtest
        mkdir -p $PKG_DIR/root/etc/config
        mkdir -p $PKG_DIR/root/etc/init.d
        mkdir -p $PKG_DIR/root/etc/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/bin
        
        # å¤åˆ¶æ–‡ä»¶
        cp openwrt/luci/controller/cfspeedtest.lua $PKG_DIR/root/usr/lib/lua/luci/controller/
        cp openwrt/luci/model/cbi/cfspeedtest/*.lua $PKG_DIR/root/usr/lib/lua/luci/model/cbi/cfspeedtest/
        cp openwrt/luci/view/cfspeedtest/*.htm $PKG_DIR/root/usr/lib/lua/luci/view/cfspeedtest/
        cp openwrt/cfspeedtest.config $PKG_DIR/root/etc/config/cfspeedtest
        cp openwrt/cfspeedtest.init $PKG_DIR/root/etc/init.d/cfspeedtest
        cp openwrt/cfspeedtest.sh $PKG_DIR/root/usr/bin/cfspeedtest
        cp openwrt/cfspeedtest_update_ip.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_ip
        cp openwrt/cfspeedtest_update_cfst.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_cfst
        cp openwrt/cfspeedtest_apply.sh $PKG_DIR/root/usr/bin/cfspeedtest_apply
        
        chmod +x $PKG_DIR/root/etc/init.d/cfspeedtest
        chmod +x $PKG_DIR/root/usr/bin/*
        
        # æŽ§åˆ¶æ–‡ä»¶
        mkdir -p $PKG_DIR/CONTROL
        cat > $PKG_DIR/CONTROL/control << 'EOF'
Package: luci-app-cfspeedtest
Version: 2.0.0
Depends: libc, luci-base, wget
Section: luci
Architecture: all
Maintainer: CloudflareSpeedTest-GUI
Description: LuCI support for CloudflareSpeedTest (Legacy Lua Version)
 é€‚ç”¨äºŽ OpenWrt 18.x - 22.x ä¼ ç»Ÿ LuCI ç‰ˆæœ¬
EOF
        
        # æ‰“åŒ…
        cd pkg-legacy
        tar -czvf data.tar.gz -C luci-app-cfspeedtest/root .
        tar -czvf control.tar.gz -C luci-app-cfspeedtest/CONTROL .
        echo "2.0" > debian-binary
        tar -czvf ../luci-app-cfspeedtest_2.0.0_legacy.ipk debian-binary data.tar.gz control.tar.gz
    
    - name: Upload Legacy artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-cfspeedtest-Legacy
        path: luci-app-cfspeedtest_2.0.0_legacy.ipk
        retention-days: 30

  build-openwrt-js:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build OpenWrt JS LuCI package
      run: |
        # åˆ›å»ºæ–°ç‰ˆ JS ç‰ˆæœ¬ ipk (OpenWrt 21.02+)
        PKG_DIR="pkg-js/luci-app-cfspeedtest"
        mkdir -p $PKG_DIR/root/www/luci-static/resources/view/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/share/luci/menu.d
        mkdir -p $PKG_DIR/root/usr/share/rpcd/acl.d
        mkdir -p $PKG_DIR/root/etc/config
        mkdir -p $PKG_DIR/root/etc/init.d
        mkdir -p $PKG_DIR/root/etc/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/bin
        
        # å¤åˆ¶ JS è§†å›¾æ–‡ä»¶
        cp openwrt/luci-js/htdocs/luci-static/resources/view/cfspeedtest/*.js $PKG_DIR/root/www/luci-static/resources/view/cfspeedtest/
        cp openwrt/luci-js/htdocs/luci-static/resources/view/cfspeedtest.js $PKG_DIR/root/www/luci-static/resources/view/
        
        # å¤åˆ¶èœå•å’Œ ACL é…ç½®
        cp openwrt/luci-js/root/usr/share/luci/menu.d/*.json $PKG_DIR/root/usr/share/luci/menu.d/
        cp openwrt/luci-js/root/usr/share/rpcd/acl.d/*.json $PKG_DIR/root/usr/share/rpcd/acl.d/
        
        # å¤åˆ¶è„šæœ¬å’Œé…ç½®
        cp openwrt/cfspeedtest.config $PKG_DIR/root/etc/config/cfspeedtest
        cp openwrt/cfspeedtest.init $PKG_DIR/root/etc/init.d/cfspeedtest
        cp openwrt/cfspeedtest.sh $PKG_DIR/root/usr/bin/cfspeedtest
        cp openwrt/cfspeedtest_update_ip.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_ip
        cp openwrt/cfspeedtest_update_cfst.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_cfst
        cp openwrt/cfspeedtest_apply.sh $PKG_DIR/root/usr/bin/cfspeedtest_apply
        
        chmod +x $PKG_DIR/root/etc/init.d/cfspeedtest
        chmod +x $PKG_DIR/root/usr/bin/*
        
        # æŽ§åˆ¶æ–‡ä»¶
        mkdir -p $PKG_DIR/CONTROL
        cat > $PKG_DIR/CONTROL/control << 'EOF'
Package: luci-app-cfspeedtest
Version: 2.0.0
Depends: libc, luci-base, wget
Section: luci
Architecture: all
Maintainer: CloudflareSpeedTest-GUI
Description: LuCI support for CloudflareSpeedTest (JS Version for OpenWrt 21.02+)
 é€‚ç”¨äºŽ OpenWrt 21.02+ / 22.x / 23.x / 24.x æ–°ç‰ˆ LuCI JS ç•Œé¢
EOF
        
        cat > $PKG_DIR/CONTROL/postinst << 'EOF'
#!/bin/sh
[ -z "$IPKG_INSTROOT" ] && {
    /etc/init.d/cfspeedtest enable
    /etc/init.d/rpcd restart
    rm -rf /tmp/luci-*
}
exit 0
EOF
        chmod +x $PKG_DIR/CONTROL/postinst
        
        # æ‰“åŒ…
        cd pkg-js
        tar -czvf data.tar.gz -C luci-app-cfspeedtest/root .
        tar -czvf control.tar.gz -C luci-app-cfspeedtest/CONTROL .
        echo "2.0" > debian-binary
        tar -czvf ../luci-app-cfspeedtest_2.0.0_js.ipk debian-binary data.tar.gz control.tar.gz
    
    - name: Upload JS artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-cfspeedtest-JS
        path: luci-app-cfspeedtest_2.0.0_js.ipk
        retention-days: 30

  release:
    needs: [build-windows, build-openwrt-legacy, build-openwrt-js]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./release
        merge-multiple: true
    
    - name: List release files
      run: ls -la ./release/
    
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT
    
    - name: Generate changelog
      id: changelog
      run: |
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "## ðŸŽ‰ CloudflareSpeedTest-GUI Release" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ðŸ“ æ›´æ–°æ—¥å¿—" >> $GITHUB_OUTPUT
        git log --pretty=format:"- %s" -10 >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "---" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "| å¹³å° | æ–‡ä»¶ | é€‚ç”¨ç‰ˆæœ¬ |" >> $GITHUB_OUTPUT
        echo "|------|------|----------|" >> $GITHUB_OUTPUT
        echo "| Windows | \`CloudflareSpeedTest-GUI.exe\` | Windows 7+ |" >> $GITHUB_OUTPUT
        echo "| OpenWrt | \`luci-app-cfspeedtest_2.0.0_js.ipk\` | **OpenWrt 21.02+** (æŽ¨è) |" >> $GITHUB_OUTPUT
        echo "| OpenWrt | \`luci-app-cfspeedtest_2.0.0_legacy.ipk\` | OpenWrt 18.x - 22.x |" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "> âš ï¸ **OpenWrt ç”¨æˆ·è¯·æ³¨æ„**: " >> $GITHUB_OUTPUT
        echo "> - å¦‚æžœä½ ä½¿ç”¨ **Kwrt / iStoreOS / OpenWrt 21.02+**ï¼Œè¯·ä¸‹è½½ **\`_js.ipk\`** ç‰ˆæœ¬" >> $GITHUB_OUTPUT
        echo "> - å¦‚æžœä½ ä½¿ç”¨ **OpenWrt 18.x/19.x** æ—§ç‰ˆæœ¬ï¼Œè¯·ä¸‹è½½ **\`_legacy.ipk\`** ç‰ˆæœ¬" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "---" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### âœ¨ åŠŸèƒ½åˆ—è¡¨" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**Windows GUI:**" >> $GITHUB_OUTPUT
        echo "- ðŸ–¥ï¸ æµ‹é€Ÿç»“æžœå®žæ—¶æ˜¾ç¤º | ðŸ“Š è¿›åº¦æ¡ | ðŸ“‹ ç»“æžœè¡¨æ ¼" >> $GITHUB_OUTPUT
        echo "- ðŸ“‹ ä¸€é”®å¤åˆ¶æœ€ä¼˜IP | ðŸŒ™ æ·±è‰²/æµ…è‰²ä¸»é¢˜ | ðŸ“Œ ç³»ç»Ÿæ‰˜ç›˜" >> $GITHUB_OUTPUT
        echo "- ðŸ”„ è‡ªåŠ¨æ›´æ–°IPåº“ | ðŸ“œ åŽ†å²è®°å½•" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**OpenWrt LuCI:**" >> $GITHUB_OUTPUT
        echo "- âš™ï¸ å¯è§†åŒ–é…ç½® | ðŸ“º å®žæ—¶æ—¥å¿— | ðŸ“Š ç»“æžœå¯è§†åŒ–" >> $GITHUB_OUTPUT
        echo "- ðŸ“œ åŽ†å²è®°å½• | â° å®šæ—¶æµ‹é€Ÿ | ðŸš€ è‡ªåŠ¨åº”ç”¨æœ€ä¼˜IP" >> $GITHUB_OUTPUT
        echo "- ðŸ”— Passwall/SSR Plus/OpenClash è”åŠ¨" >> $GITHUB_OUTPUT
        echo "- ðŸ“ è‡ªå®šä¹‰IPæ®µ | ðŸ“¤ ç»“æžœå¯¼å‡º | ðŸ”§ ç‰ˆæœ¬ç®¡ç†" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "---" >> $GITHUB_OUTPUT
        echo "æž„å»ºæ—¶é—´: ${{ steps.date.outputs.date }}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.date.outputs.date }}
        name: Release ${{ steps.date.outputs.date }}
        files: |
          ./release/*
        body: ${{ steps.changelog.outputs.changelog }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
