name: Build Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build EXE
      run: |
        if (Test-Path "app.ico") {
          pyinstaller --onefile --windowed --icon=app.ico --add-data "app.ico;." --name CloudflareSpeedTest-GUI CloudflareSpeedTest-GUI.py
        } else {
          pyinstaller --onefile --windowed --name CloudflareSpeedTest-GUI CloudflareSpeedTest-GUI.py
        }
      shell: pwsh
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: CloudflareSpeedTest-GUI-Windows
        path: dist/CloudflareSpeedTest-GUI.exe
        retention-days: 30

  build-openwrt-legacy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build OpenWrt Legacy LuCI package
      run: |
        PKG_DIR="pkg-legacy/luci-app-cfspeedtest"
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/controller
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/model/cbi/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/lib/lua/luci/view/cfspeedtest
        mkdir -p $PKG_DIR/root/etc/config
        mkdir -p $PKG_DIR/root/etc/init.d
        mkdir -p $PKG_DIR/root/etc/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/bin
        mkdir -p $PKG_DIR/CONTROL
        
        cp openwrt/luci/controller/cfspeedtest.lua $PKG_DIR/root/usr/lib/lua/luci/controller/
        cp openwrt/luci/model/cbi/cfspeedtest/*.lua $PKG_DIR/root/usr/lib/lua/luci/model/cbi/cfspeedtest/
        cp openwrt/luci/view/cfspeedtest/*.htm $PKG_DIR/root/usr/lib/lua/luci/view/cfspeedtest/
        cp openwrt/cfspeedtest.config $PKG_DIR/root/etc/config/cfspeedtest
        cp openwrt/cfspeedtest.init $PKG_DIR/root/etc/init.d/cfspeedtest
        cp openwrt/cfspeedtest.sh $PKG_DIR/root/usr/bin/cfspeedtest
        cp openwrt/cfspeedtest_update_ip.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_ip
        cp openwrt/cfspeedtest_update_cfst.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_cfst
        cp openwrt/cfspeedtest_apply.sh $PKG_DIR/root/usr/bin/cfspeedtest_apply
        
        chmod +x $PKG_DIR/root/etc/init.d/cfspeedtest
        chmod +x $PKG_DIR/root/usr/bin/*
        
        echo "Package: luci-app-cfspeedtest" > $PKG_DIR/CONTROL/control
        echo "Version: 2.0.0" >> $PKG_DIR/CONTROL/control
        echo "Depends: libc, luci-base, wget" >> $PKG_DIR/CONTROL/control
        echo "Section: luci" >> $PKG_DIR/CONTROL/control
        echo "Architecture: all" >> $PKG_DIR/CONTROL/control
        echo "Maintainer: CloudflareSpeedTest-GUI" >> $PKG_DIR/CONTROL/control
        echo "Description: LuCI support for CloudflareSpeedTest (Legacy)" >> $PKG_DIR/CONTROL/control
        
        cd pkg-legacy
        tar -czvf data.tar.gz -C luci-app-cfspeedtest/root .
        tar -czvf control.tar.gz -C luci-app-cfspeedtest/CONTROL .
        echo "2.0" > debian-binary
        tar -czvf ../luci-app-cfspeedtest_2.0.0_legacy.ipk debian-binary data.tar.gz control.tar.gz
    
    - name: Upload Legacy artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-cfspeedtest-Legacy
        path: luci-app-cfspeedtest_2.0.0_legacy.ipk
        retention-days: 30

  build-openwrt-js:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build OpenWrt JS LuCI package
      run: |
        PKG_DIR="pkg-js/luci-app-cfspeedtest"
        mkdir -p $PKG_DIR/root/www/luci-static/resources/view/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/share/luci/menu.d
        mkdir -p $PKG_DIR/root/usr/share/rpcd/acl.d
        mkdir -p $PKG_DIR/root/etc/config
        mkdir -p $PKG_DIR/root/etc/init.d
        mkdir -p $PKG_DIR/root/etc/cfspeedtest
        mkdir -p $PKG_DIR/root/usr/bin
        mkdir -p $PKG_DIR/CONTROL
        
        cp openwrt/luci-js/htdocs/luci-static/resources/view/cfspeedtest/*.js $PKG_DIR/root/www/luci-static/resources/view/cfspeedtest/
        cp openwrt/luci-js/htdocs/luci-static/resources/view/cfspeedtest.js $PKG_DIR/root/www/luci-static/resources/view/
        cp openwrt/luci-js/root/usr/share/luci/menu.d/*.json $PKG_DIR/root/usr/share/luci/menu.d/
        cp openwrt/luci-js/root/usr/share/rpcd/acl.d/*.json $PKG_DIR/root/usr/share/rpcd/acl.d/
        cp openwrt/cfspeedtest.config $PKG_DIR/root/etc/config/cfspeedtest
        cp openwrt/cfspeedtest.init $PKG_DIR/root/etc/init.d/cfspeedtest
        cp openwrt/cfspeedtest.sh $PKG_DIR/root/usr/bin/cfspeedtest
        cp openwrt/cfspeedtest_update_ip.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_ip
        cp openwrt/cfspeedtest_update_cfst.sh $PKG_DIR/root/usr/bin/cfspeedtest_update_cfst
        cp openwrt/cfspeedtest_apply.sh $PKG_DIR/root/usr/bin/cfspeedtest_apply
        
        chmod +x $PKG_DIR/root/etc/init.d/cfspeedtest
        chmod +x $PKG_DIR/root/usr/bin/*
        
        echo "Package: luci-app-cfspeedtest" > $PKG_DIR/CONTROL/control
        echo "Version: 2.0.0" >> $PKG_DIR/CONTROL/control
        echo "Depends: libc, luci-base, wget" >> $PKG_DIR/CONTROL/control
        echo "Section: luci" >> $PKG_DIR/CONTROL/control
        echo "Architecture: all" >> $PKG_DIR/CONTROL/control
        echo "Maintainer: CloudflareSpeedTest-GUI" >> $PKG_DIR/CONTROL/control
        echo "Description: LuCI support for CloudflareSpeedTest (JS for OpenWrt 21.02+)" >> $PKG_DIR/CONTROL/control
        
        echo '#!/bin/sh' > $PKG_DIR/CONTROL/postinst
        echo '[ -z "$IPKG_INSTROOT" ] && {' >> $PKG_DIR/CONTROL/postinst
        echo '    /etc/init.d/cfspeedtest enable' >> $PKG_DIR/CONTROL/postinst
        echo '    /etc/init.d/rpcd restart' >> $PKG_DIR/CONTROL/postinst
        echo '    rm -rf /tmp/luci-*' >> $PKG_DIR/CONTROL/postinst
        echo '}' >> $PKG_DIR/CONTROL/postinst
        echo 'exit 0' >> $PKG_DIR/CONTROL/postinst
        chmod +x $PKG_DIR/CONTROL/postinst
        
        cd pkg-js
        tar -czvf data.tar.gz -C luci-app-cfspeedtest/root .
        tar -czvf control.tar.gz -C luci-app-cfspeedtest/CONTROL .
        echo "2.0" > debian-binary
        tar -czvf ../luci-app-cfspeedtest_2.0.0_js.ipk debian-binary data.tar.gz control.tar.gz
    
    - name: Upload JS artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-cfspeedtest-JS
        path: luci-app-cfspeedtest_2.0.0_js.ipk
        retention-days: 30

  release:
    needs: [build-windows, build-openwrt-legacy, build-openwrt-js]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./release
        merge-multiple: true
    
    - name: List release files
      run: ls -la ./release/
    
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT
    
    - name: Generate changelog
      id: changelog
      run: |
        echo "changelog<<CHANGELOG_EOF" >> $GITHUB_OUTPUT
        echo "## CloudflareSpeedTest-GUI Release" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Download" >> $GITHUB_OUTPUT
        echo "| Platform | File | Version |" >> $GITHUB_OUTPUT
        echo "|----------|------|---------|" >> $GITHUB_OUTPUT
        echo "| Windows | CloudflareSpeedTest-GUI.exe | Windows 7+ |" >> $GITHUB_OUTPUT
        echo "| OpenWrt | luci-app-cfspeedtest_2.0.0_js.ipk | OpenWrt 21.02+ (Recommended) |" >> $GITHUB_OUTPUT
        echo "| OpenWrt | luci-app-cfspeedtest_2.0.0_legacy.ipk | OpenWrt 18.x - 22.x |" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Features" >> $GITHUB_OUTPUT
        echo "- Windows GUI with dark/light theme" >> $GITHUB_OUTPUT
        echo "- OpenWrt LuCI with real-time log" >> $GITHUB_OUTPUT
        echo "- Auto apply best IP to Passwall/SSR Plus/OpenClash" >> $GITHUB_OUTPUT
        echo "- Scheduled speed test" >> $GITHUB_OUTPUT
        echo "- History records" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "Build time: ${{ steps.date.outputs.date }}" >> $GITHUB_OUTPUT
        echo "CHANGELOG_EOF" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.date.outputs.date }}
        name: Release ${{ steps.date.outputs.date }}
        files: |
          ./release/*
        body: ${{ steps.changelog.outputs.changelog }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
